name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Set up OCaml
        uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: '4.14.0'
          opam-repositories: |
            default: https://github.com/ocaml/opam-repository.git

      - name: Install dependencies
        run: |
          opam install . --deps-only --yes

      - name: Build web demo
        run: |
          dune build web/fable_web.bc.js

      - name: Prepare files for deployment
        run: |
          mkdir -p deploy
          cp web/index.html deploy/
          cp _build/default/web/fable_web.bc.js deploy/
          cp _build/default/web/fable_web.bc.js.map deploy/ 2>/dev/null || true

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: deploy
          branch: gh-pages 